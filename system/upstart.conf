#!upstart

description "node.js app daemon"
author "Mohammad Islam"

# start after `/vagrant` shared folder is mounted
start on vagrant-mounted

# stop on system halt/reboot
stop on runlevel [06]

# tries to restart if it dies
respawn

# give up restart after 5 respawns in 60 seconds
respawn limit 5 60

script
	#export NODE_ENV=production
	exec start-stop-daemon --start --chdir /vagrant --chuid vagrant:vagrant --make-pidfile --pidfile /var/run/myapp.pid --exec /usr/local/bin/node /vagrant/app.js >> /vagrant/system/logs/server.log 2>&1
end script

pre-start script
	echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Starting" >> /vagrant/system/logs/server.log
end script

pre-stop script
	rm /var/run/myapp.pid
	echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Stopping" >> /vagrant/system/logs/server.log
end script